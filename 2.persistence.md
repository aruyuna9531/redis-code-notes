# redis 源码阅读笔记（2）持久化

## RDB

相关代码：[rdb.c](https://github.com/redis/redis/blob/unstable/src/rdb.c)

数据的全量备份，备份文件是二进制形式。

在命令行使用save和bgsave指令会进行RDB写入。save是同步写入（会阻塞主线程），bgsave是异步写入。

```cpp
rdbSave(SLAVE_REQ_NONE,server.rdb_filename,rsiptr,RDBFLAGS_NONE)
```

save指令会直接调用上述函数，阻塞住主线程等save完成。

bgsave指令会先fork出子进程，然后在子进程调用上面的rdbSave函数做一样的事情。（所以RDB不是通过多线程解决的，但却没有阻塞主线程）。

最后写出来的文件是压缩过的二进制文件（最底层调用的rioWrite函数传输字节流，算法有点抽象，有时间就去理一理）

## AOF